#1、概念
    在微服务架构中，后端服务往往不直接开放给调用端，而是通过一个API网关根据请求的url，
    路由到相应的服务。当添加API网关后，在第三方调用端和服务提供方之间就创建了一面墙，
    这面墙直接与调用方通信进行权限控制，然后将请求均衡分发给后台服务端。
    
    为什么需要网关：
        1. 客户端请求多个微服务，增加了客户端复杂性。
            每个微服务都要做用户认证，限流等，避免和多个微服务打交道的复杂性。
        
        2. 有跨域问题，不在同一个域。
        3. 认证复杂，每个服务都要独立认证，服务要求的权限不一致。
              
    默认配置：
        Zuul会代理所有注册到Eureka Server的微服务，Zuul的路由规则如下：
        http://ZUUL_HOST:ZUUL_PORT/serviceId/**会被转发到serviceId对应的微服务。
    
    zuul默认集成了：ribbon和hystrix。
    
#2、使用zuul
    1、添加依赖
        spring-cloud-starter-netflix-zuul
    2、启动类添加
        @EnableZuulProxy
            该注解声明这是一个zuul代理，该代理使用Ribbon来定位注册到server上的微服务，
            同时，整合了hystrix，实现了容错。

    3、不需要新加配置
        zuul做了默认配置。
    4、测试
        http://localhost:9100/spring-cloud-provider/hello/slt
#3、Zuul的核心
    Zuul是Netflix开源的微服务网关，核心是一系列过滤器。
    
    Filter的生命周期有4个，
        “PRE”、
             在请求被路由之前调用。我们可利用这种过滤器实现身份验证、在集群中选择请求的微服务、
             记录调试信息等
        “ROUTING”、
             将请求路由到微服务。这种过滤器用于构建发送给微服务的请求，
             并使用HttpClient或Netfilx Ribbon请求微服务。
        “POST”、
            在路由到微服务以后执行。这种过滤器可用来为响应添加标准的HTTP Header、
            收集统计信息和指标、将响应从微服务发送给客户端等
        “ERROR”
            在其他阶段发生错误时执行该过滤器。 除了默认的过滤器类型，Zuul还允许我们创建自定义的过滤器类型。
            我们可以定制一种STATIC类型的过滤器，直接在Zuul中生成响应，而不将请求转发到后端的微服务

#4、自定义Filter
    需要继承ZuulFilter的类TokenFilter，并覆盖其中的4个方法
    
    我们可以使用“PRE”类型的Filter做很多的验证工作，在实际使用中我们可以结合
    shiro、oauth2.0等技术去做鉴权、验证。
#5、路由熔断
    MsbFallback
    当我们的后端服务出现异常的时候，我们不希望将异常抛出给最外层，期望服务可以自动进行一降级。
    Zuul给我们提供了这样的支持。当某个服务出现异常时，直接返回我们预设的信息。
#6、路由重试
    有时候因为网络或者其它原因，服务可能会暂时的不可用，这个时候我们希望可以再次对服务进行重试，
    结合Spring Retry 一起来实现
    
    1。添加依赖
    1。添加配置
        #是否开启重试功能
        zuul.retryable=true
        #对当前服务的重试次数
        ribbon.MaxAutoRetries=2
        #切换相同Server的次数
        ribbon.MaxAutoRetriesNextServer=0
    缺点：
        用了retry，断路器就只有在该服务的所有实例都无法运作的情况下才能起作用。这种时候，
        断路器的形式更像是提供一种友好的错误信息，或者假装服务正常运行的假象给使用者。
#7、Zuul高可用
    前端可以同时启动多个Zuul实例进行负载，在Zuul的前端使用Nginx或者F5进行负载转发以达到高可用性。
#8、限流 ratelimit
    令牌桶可以看作是一个存放一定数量令牌的容器。系统按设定的速度向桶中放置令牌。当桶中令牌满时，多出的令牌溢出，桶中令牌不再增加。在使用令牌桶对流量规格进行评估时，是以令牌桶中的令牌数量是否足够满足报文的转发为依据的。每个需要被转发的报文，都要从令牌桶中领取一定数量的令牌（具体数量视报文大小而定），才可以被正常转发。如果桶中存在足够的令牌可以用来转发报文，称流量遵守或符合约定值，否则称为不符合或超标。
